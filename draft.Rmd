---
title: ""
geometry: "left=1.5cm,right=1.5cm,top=1.5cm,bottom=1.5cm"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


```{r include = FALSE, cache = FALSE}
load("~/all_plot.RData")
```

##Level set setting
$\gamma_X(\alpha) = \underset{n}{\operatorname{sup}}\{X:\frac{\|C_X(n)\|}{N} \le \alpha\}$, where $n$ is the number of Logmile segments needed to satisfy the condition. 

$C_X(n) = \{X:f_X(x) \ge f_{X_{(N-n+1)}}\}$, where $f_{X_{(N-n+1)}}$ is the $(N-n+1)^{th}$ ordered crash rate (from minimal to maximal crash rate).

$f_{X_{(N-n+1)}} = \phi$, where $\phi$ is the threshold that satisfies $\frac{\|C_X(n)\|}{N} \approx \alpha$. 

Suppose $\alpha = 0.05$, we can find out the threshold for weekdays is $\phi_{obs} = 0.0032$, whereas the threshold for weekend is $\phi_{pred} = 0.0039$ and the proportions of points are approximately $\alpha$ respectively (as plot showed below).

When $\alpha = 0.05$, we need to have propotion of segments identified as hotspot approximately 0.2 for weekdays and weekend. We also need to consider ties (have the same rank) and should exlude or include these segments with the same rank simutaneously in the setting. The true proportions (levels) of segments for weekdays and weekend are 0.048 and 0.037 respectively.

```{r fig.height = 3.5, fig.width = 3.5, fig.show = "hold", results = "asis"}
library(dplyr)
alpha = 0.05
t1 <- data.frame(lvl.set(z1, alpha))
t2 <- data.frame(lvl.set(z2, alpha))

par(family = "serif")
plot(z1$Logmile, z1$p, xlab = "Logmile", cex = 0, ylab = "p", main = "weekday")
segments(x0 = z1$Logmile, y0 = z1$p, y1 = 0)
points(x = z1[which(z1$p>=t1$thres), ]$Logmile, y = z1[which(z1$p>=t1$thres), ]$p)
abline(h = t1$thres, col = "darkgray")
text(x = 32, y = t1$thres, labels = round(t1$thres, 4), pos = 3)

par(family = "serif")
plot(z2$Logmile, z2$p, xlab = "Logmile", cex = 0, ylab = "p", main = "weekend")
segments(x0 = z2$Logmile, y0 = z2$p, y1 = 0)
points(x = z2[which(z2$p>=t2$thres), ]$Logmile, y = z2[which(z2$p>=t2$thres), ]$p)
abline(h = t2$thres, col = "darkgray")
text(x = 32, y = t2$thres, labels = round(t2$thres, 4), pos = 3)
```

A sequence of $\alpha$ values is used to observe the pattern in different levels, $\alpha \in [0, 1]$ with length of interval 0.01. $Y$-axis is the cumulative proportion of crashes in hotspots and $X$-axis is level of $\alpha$. Suppose $\alpha = 0.18$, roughly 82.26% and 86.92% of crashes in weekend and weekdays respectively happened on the top 18% of Logmile segments (figure showed bottom left).

A Kolmogorov-Smirnov test is performed for our surveillance plot. the statistic $D = \operatorname{max}_x|S_i(x)-S_j(x)|$, where $S_i(x)$ and $S_j(x)$ represent the cumulative distribution for $i$ and $j$ repectively. And if the maximal gap between $S_i(x)$ and $S_j(x)$, $\operatorname{max}_x|S_i(x)-S_j(x)|$, is significant, then $S_i(x)$ does not have same distribution as $S_j(x)$.

For two distribution given different time period, $D = 0.0851 < D_{0.05} = 0.1911$, shows no significant difference in distributions. The maximal distance happens at $\alpha$ level 0.11 (figure showed at bottom right). 

```{r fig.height = 3.5, fig.width = 3.5, fig.show = "hold", results = "asis"}
alpha <- seq(0, 1, by = 0.01)

par(family = "serif")
plot(x = z1.lvl$alpha, y = z1.lvl$pct.events, type = "s", 
     xlab = expression(alpha), ylab = "%events in HS")
lines(x = z2.lvl$alpha, y = z2.lvl$pct.events, type = "s", col = 4)
abline(v = 0.18, col = "darkgrey")
text(x = c(0.18, 0.18), 
     y = c(z1.lvl[alpha == 0.18,]$pct.events,z2.lvl[alpha == 0.18,]$pct.events),
     labels = round(c(z1.lvl[alpha == 0.18,]$pct.events, z2.lvl[alpha == 0.18,]$pct.events),4), 
     pos = 3, col = c(1, 4))
legend("bottomright", c("wk", "wkd"), col = c(1, 4), lty = 1)

par(family = "serif")
plot(x = alpha, y = abs(t$d), type = "s", xlab = expression(alpha), ylab = "distance")
abline(h = 0, col = "darkgray")
```

plot on the bottom left, it is plotted thresholds against true proportion of segments will be identified as hotspots. For instance, under the same threshold 0.007, top 0.98% of segments have highest ranks on crashes will be hotspots for weekdays whereas top 0.82% of segments will be hotspots for weekends. 

Plot on the bottom right, it shows the percentage of matched segments during weekdays and weekend under different levels of $\alpha$. When top 10% of segments are identified as hotspots in both period, 47.93% of segments in individual period are matched. While $\alpha$ increases to 0.2, 59.03% of segments in these periods are matched.

```{r fig.height = 3.5, fig.width = 3.5, fig.show = "hold", results = "asis"}
par(family = "serif")
plot(x = z1.lvl$thres, y = z1.lvl$level, type = "s", 
     xlab = "threshold", ylab = "%segments id as HS", 
     xlim = c(0, max(z1.lvl$thres, z2.lvl$thres)))
lines(x = z2.lvl$thres, y = z2.lvl$level, type = "s", col = 4)
abline(v = 0.007, col = "darkgrey")
text(x = c(0.007, 0.007), y = c(z1.lvl[alpha == 0.01,]$level, z2.lvl[alpha == 0.01,]$level),
     labels = round(c(z1.lvl[alpha == 0.01,]$level, z2.lvl[alpha == 0.01,]$level),4), 
     col = c(1, 4), pos = c(1,3))
legend("topright", c("wk", "wkd"), col = c(1, 4), lty = 1)

par(family = "serif")
plot(x = alpha, y = m1, type = "s", xlab = expression(alpha), ylab = "% matches")
abline(v = c(0.1, 0.2), col = "darkgrey")
text(x = c(0.1, 0.2), y = m1[c(11, 21)], labels = round(m1[c(11, 21)],4), pos = 3)
```

Relative distribution of percentage of crashes on weekdays and weekend (bottom left and bottom right). If two distributions have similar crash rates across different segments, ratios of two distributions under the same $alpha$ level should be equal to 1. In here, we can perform a Kolmogorov-Smirnov test to see the magnitude of diversity by comparing relative distribution to uniform distribution. On the bottom right is the result of converting relative and uniform distributions to cumulative probability functions respectively (black represents uniform, blue represents our relative distribution and red is the confidence band for our relativef distribution).
Either from a confidence band or KS test perspective, both results show no difference in distributions. The uniform lies within the confidence bands, and $\operatorname{max}_x|S_i(x)-S_j(x)|$, where $S_i(x)$ here stands for relative distribution and $S_j(x)$ is uniform, is $0.0037 < D_{0.05} = 0.1921$.

```{r fig.height = 3.5, fig.width = 3.5, fig.show = "hold", results = "asis"}
par(family = "serif")
plot(x = alpha, y = r, type = "s", 
     xlab = expression(alpha), 
     ylab = "pct crashes (weekdays)/pct crashes (weekend)")
abline(h = 1, col = "darkgrey")

par(family = "serif")
plot(x = alpha[is.finite(r)], y = cumsum(r1[is.finite(r1)]), 
     type = "s", xlab = expression(alpha), ylab = "cumulative ", col = 4)
lines(x = alpha[is.finite(r)], y = cumsum(r2), type = "s")
abline(v = seq(0, 1, by = 0.2), h = seq(0, 1, by = 0.2), col = "lightgrey")

c.alpha <- sqrt(-0.5*log(0.05/2)) 
bound <- c.alpha*sqrt(1/100+1/100)
low <- cumsum(r1[is.finite(r1)])-bound
up <- cumsum(r1[is.finite(r1)])+bound
low[low<0]=0
up[up>1]=1
lines(x = alpha[is.finite(r)], y = low, type = "s", col = 2)
lines(x = alpha[is.finite(r)], y = up, type = "s", col = 2)
```

This is also a result for KS test in a different perspective. We plot distances between distributions under certain $\alpha$ values. We can expect differences should be 0 if two distributions are the same. The confidence bands are merely plus and minus confidence coefficients at significance level 0.05.

```{r}
par(family = "serif")
ds <- cumsum(r1[is.finite(r1)])-cumsum(r2)
plot(x = alpha[is.finite(r)], y = ds, cex = 0, xlab = expression(alpha),
     ylab = "distance in distribution", ylim = c(-1, 1))
segments(x0 = alpha[is.finite(r)], y0 = ds, y1 = 0)
lines(x = alpha[is.finite(r)], y = rep(bound, 100), type = "s", col = 2)
lines(x = alpha[is.finite(r)], y = rep(-bound, 100), type = "s", col = 2)
```

We may not need to seperate data into different time period (weekdays and weekend).

see day of week performance.

```{r include = FALSE, cache = FALSE}
load("~/dow.RData")
```

the summary table below shows the detail for each day of week when $\alpha = 0.05$. $Level$ is the true proportion of segments that closer and less than size $\alpha$; $nseg$ represents total number of segments needed to reach the level (or above the threshold), $pct.events$ is the proportion of events (sum of events in $nseg$); $thres$ is the threshold (lowest percentage of events within the $level$); $DayOfWeekUSA$ starts from Sunday (1) to Saturday (7).

```{r}
library(knitr)
kable(out %>% mutate(DayOfWeekUSA = time) %>% select(-time))
```

here's the distribution for the summary table showed previously. $level$ is made of the ratio of blue dots to total segments; $nseg$ is the number of blue dots; grey horizontal line is the threshold; total proportion of events happened on these blue dots (hotspots) are $pct.events$.

```{r}
library(ggplot2)
ggplot(data = week, mapping = aes(x = Logmile, y = p)) +
  geom_segment(aes(xend = Logmile, yend = 0)) + 
  geom_hline(aes(yintercept=hl), data=hline.dat, col = "darkgray") + 
  geom_point(data = point.dat, aes(x = Logmile, y = p), col = 4) + 
  facet_grid(DayOfWeekUSA~.)
```

recall from a surveillance plot, its x-axis represents the proportion of segments identified as hotspots ($\alpha$) or distance between segments because of constant interval, and its y-axis represents proportion of events happened in these hotspots.

we use KS test to see the significance in distributions of days of week from this surveillance perspective.

no significance in distribution 
\begin{table}[ht]\centering\begin{tabular}{rllrl}
\hline 1 & Mon & Tue, Wed, Thu, Fri \\
       2 & Tue & Wed, Thu, Fri \\
       3 & Wed & Thu, Fri \\
\hline\end{tabular}\end{table}

#data separation given different time

only for original data, without any setting

ks test: route 71, 2015 jan ~ dec (crtical point: 0.0449)
\begin{table}[ht]\centering\begin{tabular}{rllrl}
\hline Same \\
       1 & Jan & Jul, Sep, Oct\\
       2 & Mar & Sep, Oct\\
       3 & May & Aug\\
       4 & Jul & Sep\\
       5 & Sep & Oct\\
       6 & Nov & Dec\\
\hline\end{tabular}\end{table}
 
ks test: route 71, 2015 sun ~ sat (crtical point: 0.0449)
\begin{table}[ht]\centering\begin{tabular}{rllrl}
\hline Same \\
       1 & mon & tue (0.0304), wed (0.0407), fri (0.0286)\\
       2 & tue & wed (0.0418), thu (0.0433), fri (0.0314), sat (0.0399)\\
       3 & wed & thu (0.0366), fri (0.0427), sat (0.0371)\\
       Diff\\
       1 & mon & thu (0.0484), sat (0.0513), sun (0.0746)\\
       2 & tue & sun (0.0673)\\
       3 & wed & sun (0.0831)\\
       4 & thu & fri (0.0470), sat (0.0470), sun (0.0961)\\
       5 & fri & sat (0.0497), sun (0.0644)\\
       6 & sat & sun (0.0842)\\
\hline\end{tabular}\end{table}

result 1 (tod: 2 groups) (critical point = 0.0449)
\begin{table}[ht]\centering\begin{tabular}{rllrl}
\hline Diff \\
       1 & 0am-12pm, 12pm-0am (0.0494)\\
\hline\end{tabular}\end{table}

result 2 (tod: 3 groups) (critical point = 0.0449)
\begin{table}[ht]\centering\begin{tabular}{rllrl}
\hline Same \\
       1 & 8-16 & 16-24 (0.0370)\\
       Diff \\
       1 & 0-8 & 8-16 (0.1077)\\
       2 & 8-16 & 16-24 (0.0370)\\
\hline\end{tabular}\end{table}

result 3 (tod: 6 groups) (critical point = 0.0449)
\begin{table}[ht]\centering\begin{tabular}{rllrl}
\hline Same \\
       1 & 8-12 & 16-20 (0.0413)\\
       2 & 12-16 & 16-20 (0.0427)\\
       Diff \\
       1 & 0-4 & 4-8 (0.0863), 8-12 (0.1338), 12-16 (0.1469), 16-20 (0.1593), 20-24 (0.1481)\\
       2 & 4-8 & 8-12 (0.0918), 12-16 (0.0844), 16-20 (0.1009), 20-24 (0.0730)\\
       3 & 8-12 & 12-16 (0.0588), 20-24 (0.0642)\\
       4 & 12-16 & 20-24 (0.0499)\\
       5 & 16-20 & 20-24 (0.0639)\\
\hline\end{tabular}\end{table}

result 4 (tod: 12 groups) (critical point = 0.0449)
\begin{table}[ht]\centering\begin{tabular}{rllrl}
\hline Same \\
       1 & 10-12 & 12-14\\
       2 & 12-14 & 16-18, 18-20\\
       3 & 16-18 & 18-20\\
       4 & 18-20 & 20-22\\
\hline\end{tabular}\end{table}






$\lambda(x)$, intensity/rate for segment $x$ represent observed data.

$\hat{\lambda}(x)$, intensity/rate for segment $x$ represent predictions.

ratio $r = \frac{p(x:\lambda(x)\ge\phi_\alpha)}{p(x:\hat{\lambda}(x)\ge\phi_\alpha)}$

In prediction manner, if we expect our prediction is completely as same as observed data, the ratio $r$ should always be 1 in the relative distribution plot, and be straight line with slope of 1 in CDF plot. To see the devation of our prediction and data, quasi-KS and chi-squared tests are performed and shown no significance exists.